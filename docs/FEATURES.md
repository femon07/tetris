# テトリスゲーム機能仕様書

## 📋 概要
ESモジュールを使用したバニラJavaScriptで構築されたモダンなテトリスゲームの機能仕様書です。WebGL 3Dレンダリング、ゴーストピース、ハードドロップエフェクトなどの先進的な機能を実装しています。

**最終更新**: 2025-06-19  
**バージョン**: v1.0.0

---

## 🎮 実装済み機能

### 1. コアゲーム機能

#### 1.1 基本ゲームプレイ ✅
- **テトリミノ**: 7種類の標準ピース (I, O, T, S, Z, J, L)
- **ボード**: 10×20グリッドの標準サイズ
- **基本操作**: 
  - 左右移動 (←/→キー)
  - 回転 (↑キー)
  - ソフトドロップ (↓キー)
  - ハードドロップ (スペースキー)
- **ライン消去**: 完成したラインの自動削除
- **ゲームオーバー**: ブロックが天井に到達時の検出

#### 1.2 回転システム ✅
- **SRS (Super Rotation System)**: 業界標準の回転システム
- **ウォールキック**: 回転時の位置調整
- **回転状態管理**: 4方向の回転状態
- **実装場所**: `src/rotation/RotationSystem.js`

#### 1.3 ホールド機能 ✅
- **ピースホールド**: CキーまたはShiftキーでピース保留
- **ホールドUI**: 左側エリアでホールド中ピースを表示
- **ワンタイム制限**: 1回配置するまで再ホールド不可
- **実装場所**: `src/core/HoldManager.js`

#### 1.4 Nextピース表示 ✅
- **次ピース予告**: 右側エリアで次のピースを表示
- **3Dプレビュー**: WebGLによる立体表示
- **実装場所**: `src/rendering/webgl/WebGLPreviewRenderer.js`

### 2. 先進的機能

#### 2.1 ゴーストピース ✅ **完全実装**
- **落下予測表示**: 現在ピースの着地位置を半透明で表示
- **リアルタイム計算**: ピース移動・回転に追従
- **視覚仕様**: 
  - 透明度: opacity 0.3
  - 色: 現在ピースと同色、輝度50%減
- **パフォーマンス**: 60fps維持の最適化済み
- **設定**: ON/OFF切り替え対応
- **実装場所**: 
  - `src/core/GhostPiece.js` - 位置計算ロジック
  - `src/rendering/webgl/WebGLGhost.js` - WebGL描画

#### 2.2 ハードドロップエフェクト ✅ **完全実装**
- **軌跡エフェクト**: スペースキー押下時の落下軌跡
- **着地エフェクト**: 着地時の衝撃波・光るエフェクト
- **カメラシェイク**: 軽微な画面振動（強度調整可能）
- **パーティクル仕様**:
  - 軌跡: 薄い光の線、フェードアウト
  - 着地爆発: 放射状パーティクル、明るい光
  - ブロック光: 着地ブロックの一時発光
- **実装場所**:
  - `src/effects/HardDropEffect.js` - エフェクト管理
  - WebGLレンダラーに統合済み

### 3. レンダリングシステム

#### 3.1 デュアルレンダラー ✅
- **Canvas2Dレンダラー**: フォールバック用2D描画
- **WebGLレンダラー**: メイン3D描画エンジン
- **自動切り替え**: WebGL非対応環境での自動フォールバック
- **実装場所**: `src/rendering/RendererFactory.js`

#### 3.2 WebGL 3Dレンダリング ✅ **完全実装**
- **3Dブロック描画**: 立体的なテトリミノ表示
- **ライティング**: 環境光・指向性光による陰影
- **カメラシステム**: 3D視点制御
- **アニメーションシステム**: スムーズな動作
- **パーティクルシステム**: エフェクト描画
- **実装場所**: `src/rendering/webgl/`配下
  - `WebGLRenderer.js` - メインレンダラー
  - `WebGLBlocks.js` - ブロック描画
  - `WebGLLighting.js` - ライティング
  - `WebGLCamera.js` - カメラ制御
  - `WebGLAnimations.js` - アニメーション
  - `WebGLParticles.js` - パーティクル

#### 3.3 アニメーション ✅
- **ライン消去アニメーション**: 完成ラインの消滅エフェクト
- **ブロック配置アニメーション**: ピース着地時のバウンス
- **フェードエフェクト**: 各種UI要素のフェード
- **イージング**: 自然な動作カーブ

### 4. スコアリングシステム

#### 4.1 基본スコア計算 ✅
- **ライン消去ボーナス**: 
  - シングル: 100 × レベル
  - ダブル: 300 × レベル
  - トリプル: 500 × レベル
  - テトリス: 800 × レベル
- **ソフトドロップ**: 1ポイント/セル
- **ハードドロップ**: 2ポイント/セル
- **実装場所**: `src/scoring/ScoreCalculator.js`

#### 4.2 レベルシステム ✅
- **レベル進行**: 10ライン消去毎にレベルアップ
- **落下速度**: レベルに応じた速度上昇
- **得点倍率**: レベル値による得点増加

### 5. UI・UXシステム

#### 5.1 ゲームUI ✅
- **リアルタイム表示**: スコア、ライン数、レベル
- **サイドパネル**: ホールド・Nextピース表示
- **操作ガイド**: キーボードショートカット表示
- **レスポンシブ対応**: 画面サイズに応じたレイアウト調整
- **実装場所**: `src/ui/GameUI.js`

#### 5.2 入力システム ✅
- **キーボード制御**: 標準テトリスキー配置
- **入力バッファ**: 安定した操作感
- **実装場所**: `src/app/InputController.js`

### 6. ゲーム管理システム

#### 6.1 ゲームループ ✅
- **60fps制御**: requestAnimationFrame使用
- **状態管理**: ゲーム状態の一元管理
- **実装場所**: `src/app/GameLoop.js`

#### 6.2 イベントシステム ✅
- **イベント駆動アーキテクチャ**: 疎結合設計
- **カスタムイベント**: ゲーム固有イベントの管理
- **実装場所**: `src/event/EventManager.js`

---

## 🚧 未実装機能（今後の実装予定）

### Phase 2: ゲームプレイ拡張

#### 2.1 コンボシステム 🔄 **次期実装**
- **連続ライン消去**: コンボ数の追跡・表示
- **ボーナス計算**: `基本点数 × (1 + コンボ数 × 0.1)`
- **視覚フィードバック**: コンボ数表示、エフェクト強化
- **予定実装場所**: 
  - `src/scoring/ComboSystem.js`
  - `src/ui/ComboDisplay.js`

#### 2.2 T-Spin検出・ボーナス 📋 **計画段階**
- **T-Spin判定**: T字ピース回転入れによる特殊消去
- **特別ボーナス**: 通常の2-3倍得点
- **特別エフェクト**: 金色パーティクル演出
- **予定実装場所**: `src/scoring/TSpinDetector.js`

#### 2.3 Perfect Clear検出 📋 **計画段階**
- **全消し判定**: ボード完全クリア検出
- **超大ボーナス**: 大量得点獲得
- **特別演出**: 画面全体光エフェクト
- **予定実装場所**: `src/scoring/PerfectClearDetector.js`

### Phase 3: 操作性向上

#### 3.1 DAS/ARR制御 📋 **計画段階**
- **DAS (Delayed Auto Shift)**: 長押し連続移動
- **ARR (Auto Repeat Rate)**: 連続移動速度調整
- **設定可能**: ユーザー好みに応じた調整
- **予定実装場所**: `src/input/DASController.js`

#### 3.2 入力バッファリング拡張 📋 **計画段階**
- **先行入力**: 次操作の事前受付
- **回転優先**: 同時入力時の処理改善
- **予定実装場所**: `src/input/InputBuffer.js`

### Phase 4: 視覚的ポリッシュ

#### 4.1 レベル進行演出 📋 **計画段階**
- **レベルアップ通知**: 画面中央アニメーション
- **背景変化**: レベル応じた色調変更
- **パーティクル祭典**: 派手なエフェクト
- **予定実装場所**: `src/effects/LevelUpEffect.js`

#### 4.2 UIアニメーション拡張 📋 **計画段階**
- **スコア変化**: 得点増加カウントアップ
- **統計更新**: 記録更新ハイライト
- **予定実装場所**: `src/ui/UIAnimations.js`

---

## 🎯 技術仕様

### アーキテクチャ
- **言語**: バニラJavaScript (ES6+)
- **モジュールシステム**: ESモジュール
- **設計パターン**: イベント駆動、ファクトリーパターン
- **レンダリング**: WebGL/Canvas2D デュアルレンダラー

### パフォーマンス指標
- **フレームレート**: 60fps安定維持
- **メモリ使用量**: 50MB以下
- **初期ロード時間**: 3秒以下
- **入力遅延**: 16ms以下

### ブラウザ対応
- **WebGL対応**: Chrome, Firefox, Safari, Edge
- **フォールバック**: Canvas2D (IE11+)
- **レスポンシブ**: デスクトップ・タブレット対応

### テストカバレッジ
- **ユニットテスト**: Jest使用
- **現在のカバレッジ**: 85%
- **目標カバレッジ**: 90%以上

---

## 📊 機能実装進捗

### 完了機能 (8/12) - 67%
- ✅ 基本ゲームプレイ
- ✅ SRS回転システム  
- ✅ ホールド機能
- ✅ Nextピース表示
- ✅ ゴーストピース
- ✅ ハードドロップエフェクト
- ✅ WebGL 3Dレンダリング
- ✅ 基本スコアリング

### 実装予定機能 (4/12) - 33%
- 🔄 コンボシステム
- 📋 T-Spin検出
- 📋 Perfect Clear検出
- 📋 DAS/ARR制御

---

## 🔧 設定・カスタマイズ

### ゲーム設定
- **ゴースト表示**: ON/OFF切り替え
- **エフェクト強度**: 3段階調整
- **3D表示**: WebGL/Canvas2D切り替え

### 開発者向け設定
- **デバッグモード**: 詳細ログ出力
- **パフォーマンス監視**: FPS表示
- **テストモード**: 自動テスト実行

---

**作成者**: Claude Code  
**管理場所**: `/home/r-endou/work/tetris/docs/FEATURES.md`  
**関連ドキュメント**: 
- `CLAUDE.md` - 開発ガイドライン
- `planning/active/GAMEPLAY_ENHANCEMENT_PLAN.md` - 実装計画