# ゲームプレイ機能拡張計画

## 📋 概要
WebGL 3Dレンダラー完成後の第一弾として、ゲームプレイの楽しさとやりがいを向上させる機能を実装する。
既存の3D基盤を最大限活用し、より魅力的なテトリス体験を提供する。

## 🎯 実装目標
- **即座のユーザー体験向上**: 見た目と操作感の改善
- **ゲームの奥深さ追加**: 上級者向け要素の導入
- **視覚的満足度向上**: 3Dエフェクトを活用した演出

## 🚀 Phase 1: コア機能拡張

### 1.1 ゴースト表示 ⭐⭐⭐⭐⭐ (最優先)
**目標**: 落下予測位置の視覚化でプレイしやすさ向上

#### 実装詳細
- **表示方式**: 半透明ブロック（opacity: 0.3）
- **色設定**: 現在ピースと同色、輝度を下げた表示
- **3D対応**: WebGLレンダラーでの専用マテリアル作成
- **位置計算**: リアルタイム落下シミュレーション

#### 技術仕様
```javascript
// 新規作成ファイル
src/core/GhostPiece.js
src/rendering/webgl/WebGLGhost.js

// 既存ファイル修正
src/core/Game.js - ゴーストピース計算ロジック
src/rendering/WebGLRenderer.js - ゴースト描画統合
```

#### 実装手順
1. ゴースト位置計算ロジック作成
2. WebGL用半透明マテリアル実装
3. レンダリングパイプラインに統合
4. 設定でON/OFF切り替え対応

---

### 1.2 ハードドロップエフェクト ⭐⭐⭐⭐
**目標**: スペースキー瞬間落下時の視覚的インパクト

#### 実装詳細
- **軌跡エフェクト**: 落下経路にパーティクル軌跡
- **着地エフェクト**: 強い衝撃波、光る演出
- **音響エフェクト**: 着地音（将来対応）
- **カメラシェイク**: 軽微な画面振動

#### 技術仕様
```javascript
// 新規作成ファイル  
src/effects/HardDropEffect.js
src/rendering/webgl/WebGLHardDrop.js

// 既存ファイル修正
src/core/Game.js - ハードドロップ検出
src/ui/GameUI.js - キー入力処理拡張
```

#### エフェクト詳細
- **軌跡パーティクル**: 薄い光の線、フェードアウト
- **着地爆発**: 放射状パーティクル、明るい光
- **ブロック光**: 着地ブロックを一時的に光らせる

---

### 1.3 基本コンボシステム ⭐⭐⭐⭐
**目標**: 連続ライン消去への報酬システム

#### 実装詳細
- **コンボ判定**: 連続でラインを消去した回数をカウント
- **得点ボーナス**: コンボ数に応じた得点倍率
- **視覚フィードバック**: コンボ数表示、効果音
- **エフェクト強化**: 高コンボ時のパーティクル増強

#### 技術仕様
```javascript
// 新規作成ファイル
src/scoring/ComboSystem.js
src/ui/ComboDisplay.js

// 既存ファイル修正
src/core/Game.js - コンボ状態管理
src/scoring/ScoreCalculator.js - コンボボーナス計算
```

#### コンボシステム詳細
- **コンボ継続**: ラインを消さずにピースを置くとリセット
- **ボーナス計算**: `基本点数 × (1 + コンボ数 × 0.1)`
- **最大コンボ**: 記録として保存、UI表示

---

## 🚀 Phase 2: 上級機能追加

### 2.1 レベル進行演出 ⭐⭐⭐
**目標**: レベルアップ時の達成感向上

#### 実装詳細
- **レベルアップ通知**: 画面中央にアニメーション表示
- **背景変化**: レベルに応じた色調変更
- **パーティクル祭典**: レベルアップ時の派手なエフェクト
- **速度変化演出**: スムーズな落下速度遷移

### 2.2 T-Spin検出・ボーナス ⭐⭐⭐⭐
**目標**: 高度テクニックへの対応

#### 実装詳細
- **T-Spin判定**: T字ピースの回転入れによるライン消去検出
- **特別ボーナス**: 通常の2-3倍の得点
- **特別エフェクト**: 金色パーティクル、特殊サウンド
- **統計記録**: T-Spin成功回数の記録

### 2.3 Perfect Clear検出 ⭐⭐⭐
**目標**: 全消し技術への報酬

#### 実装詳細
- **全消し判定**: ボードが完全に空になった状態検出
- **超大ボーナス**: 大量得点獲得
- **特別演出**: 画面全体に光るエフェクト
- **レア実績**: 統計での特別表示

---

## 🎮 Phase 3: 操作性向上

### 3.1 ピース操作改善 ⭐⭐⭐
- **DAS (Delayed Auto Shift)**: 長押し時の連続移動
- **ARR (Auto Repeat Rate)**: 連続移動の速度調整
- **ソフトドロップ強化**: より細かい落下制御

### 3.2 入力バッファリング ⭐⭐⭐
- **先行入力**: 次の操作を事前に受け付け
- **回転優先**: 移動と回転の同時入力時の処理改善
- **キャンセル機能**: 誤操作の取り消し（制限付き）

---

## 🎨 Phase 4: 視覚的ポリッシュ

### 4.1 ピースアニメーション ⭐⭐⭐
- **スムーズ移動**: ブロック移動時のイージング
- **回転アニメーション**: 3D回転の滑らかな表現
- **落下予告**: ピースが落ちる直前の微細な揺れ

### 4.2 UIアニメーション ⭐⭐⭐
- **スコア変化**: 得点増加時のカウントアップ
- **レベル表示**: レベル変化時のフェード効果
- **統計更新**: 記録更新時のハイライト

---

## 📊 実装順序・スケジュール

### Week 1: 基盤実装 🚧
1. **Day 1-2**: ゴースト表示実装 ✅ **完了**
   - ゴースト位置計算ロジック ✅
   - WebGL半透明マテリアル ✅
2. **Day 3-4**: ゴースト表示統合・テスト ✅ **完了**
   - レンダリングパイプライン統合 ✅
   - 視覚調整・バグ修正 ✅
3. **Day 5**: ハードドロップエフェクト基盤 🔄 **次回実装**
   - エフェクトクラス作成
   - 基本パーティクル実装

### Week 2: エフェクト強化
1. **Day 1-2**: ハードドロップエフェクト完成
   - 軌跡・着地エフェクト
   - カメラシェイク実装
2. **Day 3-4**: コンボシステム実装
   - コンボ判定ロジック
   - 得点計算統合
3. **Day 5**: UI表示・統合テスト
   - コンボ表示UI
   - 全体動作確認

### Week 3: ポリッシュ・拡張
1. **Day 1-2**: レベル進行演出
2. **Day 3-4**: T-Spin/Perfect Clear検出
3. **Day 5**: 最終調整・バグ修正

---

## 🎯 成功指標

### 機能指標
- **ゴースト表示**: ✅ 正確な位置計算、60fps維持
- **ハードドロップ**: 🔄 視覚的インパクト、パフォーマンス安定
- **コンボシステム**: 📋 正確な判定、適切なバランス

### ユーザー体験指標
- **操作レスポンス**: 入力遅延なし
- **視覚的満足度**: エフェクトのクオリティ
- **学習曲線**: 機能の直感的理解
- **再プレイ価値**: コンボ・記録への挑戦意欲

### 技術指標
- **パフォーマンス**: 60fps安定維持
- **メモリ使用量**: 増加を最小限に抑制
- **コード品質**: テストカバレッジ90%以上
- **設計品質**: 既存アーキテクチャとの統合

---

## 🔧 技術実装詳細

### 新規ファイル構成
```
src/
├── core/
│   ├── GhostPiece.js          # ゴースト位置計算
│   └── ComboTracker.js        # コンボ状態管理
├── effects/
│   ├── HardDropEffect.js      # ハードドロップエフェクト
│   ├── ComboEffect.js         # コンボエフェクト
│   └── LevelUpEffect.js       # レベルアップ演出
├── rendering/webgl/
│   ├── WebGLGhost.js          # ゴースト専用レンダリング
│   └── WebGLHardDrop.js       # ハードドロップエフェクト
└── ui/
    ├── ComboDisplay.js        # コンボ表示UI
    └── EffectDisplay.js       # エフェクト通知UI
```

### 既存ファイル拡張
```
src/core/Game.js
- getGhostPosition() メソッド追加
- handleHardDrop() メソッド拡張
- updateComboState() メソッド追加

src/scoring/ScoreCalculator.js  
- calculateComboBonus() メソッド追加
- calculateTSpinBonus() メソッド追加

src/rendering/WebGLRenderer.js
- ゴースト描画統合
- エフェクト管理システム統合
```

---

## 🚧 リスク・対策

### パフォーマンスリスク
- **エフェクト過多**: パーティクル数制限、LOD適用
- **計算負荷**: ゴースト計算の最適化、キャッシュ活用
- **メモリリーク**: エフェクトオブジェクトの適切な破棄

### UXリスク
- **視覚的混乱**: ゴースト表示の適切な透明度調整
- **操作阻害**: エフェクトが操作の邪魔をしない配慮
- **学習コスト**: 新機能の直感的な理解

### 技術リスク
- **既存システム影響**: 段階的統合、回帰テスト充実
- **ブラウザ互換性**: エフェクトのフォールバック対応
- **複雑性増大**: モジュラー設計の維持

---

**作成日**: 2025-06-19  
**対象**: ゲームプレイ機能拡張 (Option A)  
**前提**: WebGL Renderer完成済み  
**予定期間**: 3週間